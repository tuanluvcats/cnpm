@model IEnumerable<global::SanBong.Models.DatSan>

@{
    ViewData["Title"] = "Lịch Sử Đặt Sân";
}

<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-clock-history"></i> Lịch Sử Đặt Sân</h2>
                <a href="/" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Quay Lại
                </a>
            </div>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mã Đặt Sân</th>
                                        <th>Sân Bóng</th>
                                        <th>Khung Giờ</th>
                                        <th>Ngày Đặt</th>
                                        <th>Ngày Sử Dụng</th>
                                        <th>Tổng Tiền</th>
                                        <th>Trạng Thái</th>
                                        <th>Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        <tr>
                                            <td><strong>#@item.MaDatSan</strong></td>
                                            <td>
                                                <i class="bi bi-flag"></i> 
                                                @(item.MaSanNavigation != null ? item.MaSanNavigation.TenSan : "N/A")
                                            </td>
                                            <td>
                                                @if (item.MaKhungGioNavigation != null)
                                                {
                                                    <span class="badge bg-info">
                                                        <i class="bi bi-clock"></i>
                                                        @item.MaKhungGioNavigation.GioBatDau.ToString(@"hh\:mm") - 
                                                        @item.MaKhungGioNavigation.GioKetThuc.ToString(@"hh\:mm")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">Tùy chỉnh</span>
                                                }
                                            </td>
                                            <td>@item.NgayDat.ToString("dd/MM/yyyy")</td>
                                            <td>@item.NgaySd.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>
                                                <strong class="text-success">
                                                    @((item.TongTien ?? 0).ToString("N0")) VNĐ
                                                </strong>
                                            </td>
                                            <td>
                                                @{
                                                    var badgeClass = item.TrangThai switch
                                                    {
                                                        "Chờ xác nhận" => "bg-warning text-dark",
                                                        "Đã xác nhận" => "bg-primary",
                                                        "Đang sử dụng" => "bg-info",
                                                        "Hoàn tất" => "bg-success",
                                                        "Đã hủy" => "bg-danger",
                                                        _ => "bg-secondary"
                                                    };
                                                }
                                                <span class="badge @badgeClass">
                                                    @item.TrangThai
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="xemChiTiet(@item.MaDatSan)">
                                                    <i class="bi bi-eye"></i> Xem
                                                </button>
                                                @if (item.TrangThai == "Chờ xác nhận")
                                                {
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="huyDatSan(@item.MaDatSan)">
                                                        <i class="bi bi-x-circle"></i> Hủy
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h4 class="text-primary">@Model.Count()</h4>
                        <p class="mb-0">Tổng Đơn</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h4 class="text-warning">@Model.Count(d => d.TrangThai == "Chờ xác nhận")</h4>
                        <p class="mb-0">Chờ Xác Nhận</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h4 class="text-success">@Model.Count(d => d.TrangThai == "Hoàn tất")</h4>
                        <p class="mb-0">Hoàn Tất</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h4 class="text-info">@Model.Sum(d => d.TongTien ?? 0).ToString("N0") VNĐ</h4>
                        <p class="mb-0">Tổng Chi Tiêu</p>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3">Chưa Có Lịch Sử Đặt Sân</h4>
                        <p class="text-muted">Bạn chưa đặt sân nào. Hãy bắt đầu đặt sân ngay hôm nay!</p>
                        <a href="/DatSan/Create" class="btn btn-primary mt-3">
                            <i class="bi bi-plus-circle"></i> Đặt Sân Ngay
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Chi Tiết Modal -->
<div class="modal fade" id="chiTietModal" tabindex="-1" aria-labelledby="chiTietModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chiTietModalLabel">Chi Tiết Đặt Sân</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="chiTietContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .card {
            border-radius: 10px;
            border: none;
        }
        
        .table thead th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .badge {
            padding: 0.5em 0.8em;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
    </style>
}

@section Scripts {
    <script>
        function xemChiTiet(maDatSan) {
            $('#chiTietModal').modal('show');
            $('#chiTietContent').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Đang tải...</span></div></div>');
            
            $.get('/DatSan/Details/' + maDatSan, function(data) {
                $('#chiTietContent').html(data);
            }).fail(function() {
                $('#chiTietContent').html('<div class="alert alert-danger">Không thể tải chi tiết. Vui lòng thử lại sau.</div>');
            });
        }
        
        function huyDatSan(maDatSan) {
            if (confirm('Bạn có chắc muốn hủy đơn đặt sân này?')) {
                $.ajax({
                    url: '/DatSan/Cancel',
                    type: 'POST',
                    data: {
                        id: maDatSan,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(result) {
                        if (result.success) {
                            alert('Hủy đơn đặt sân thành công!');
                            location.reload();
                        } else {
                            alert('Lỗi: ' + (result.message || 'Không thể hủy đơn'));
                        }
                    },
                    error: function() {
                        alert('Đã xảy ra lỗi. Vui lòng thử lại sau.');
                    }
                });
            }
        }
    </script>
}
